<!DOCTYPE html>
<!--[if IE 7]>
<html class="ie ie7" lang="pt-BR" xmlns:fb="http://www.facebook.com/2008/fbml" xmlns:og="http://opengraphprotocol.org/schema/">
<![endif]-->
<!--[if IE 8]>
<html class="ie ie8" lang="pt-BR" xmlns:fb="http://www.facebook.com/2008/fbml" xmlns:og="http://opengraphprotocol.org/schema/">
<![endif]-->
<!--[if !(IE 7) & !(IE 8)]><!-->
<html lang="pt-BR" xmlns:fb="http://www.facebook.com/2008/fbml" xmlns:og="http://opengraphprotocol.org/schema/">
<!--<![endif]-->
<head>
<base href="https://rafaelbiriba.com/blogwp.html" />

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>upload | Rafael Biriba Blog</title>
	
	
	<!--[if lt IE 9]>
	<script src="https://rafaelbiriba.com/wp-content/themes/twentyfourteen/js/html5.js"></script>
	<![endif]-->
	
<!-- All in One SEO Pack 2.3.8 by Michael Torbert of Semper Fi Web Design[576,610] -->
<meta name="keywords"  content="codigo,desenvolvimento,net-sftp,net-ssh,progress,progresso,ruby,rubygems,sftp,upload,conex√£o,connection,rufus,scheduler,timeout" />

<link rel="canonical" href="https://rafaelbiriba.com/tag/upload" />
<!-- /all in one seo pack -->



		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/www.rafaelbiriba.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.5.3"}};
			!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;if(!g||!g.fillText)return!1;switch(g.textBaseline="top",g.font="600 32px Arial",a){case"flag":return g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3;case"diversity":return g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,d=c[0]+","+c[1]+","+c[2]+","+c[3],g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e;case"simple":return g.fillText(h(55357,56835),0,0),0!==g.getImageData(16,16,1,1).data[0];case"unicode8":return g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='wgs-css'  href='https://rafaelbiriba.com/wp-content/plugins/wp-google-search/wgs.css?ver=4.5.3' type='text/css' media='all' />
<link rel='stylesheet' id='contact-form-7-css'  href='https://rafaelbiriba.com/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=4.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='wp-pagenavi-css'  href='https://rafaelbiriba.com/wp-content/plugins/wp-pagenavi/pagenavi-css.css?ver=2.70' type='text/css' media='all' />
<link rel='stylesheet' id='wp-syntax-css-css'  href='https://rafaelbiriba.com/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='twentyfourteen-lato-css'  href='https://fonts.googleapis.com/css?family=Lato%3A300%2C400%2C700%2C900%2C300italic%2C400italic%2C700italic&#038;subset=latin%2Clatin-ext' type='text/css' media='all' />
<link rel='stylesheet' id='genericons-css'  href='https://rafaelbiriba.com/wp-content/themes/twentyfourteen/genericons/genericons.css?ver=3.0.3' type='text/css' media='all' />
<link rel='stylesheet' id='twentyfourteen-style-css'  href='https://rafaelbiriba.com/wp-content/themes/twentyfourteen/style.css?ver=4.5.3' type='text/css' media='all' />
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentyfourteen-ie-css'  href='https://rafaelbiriba.com/wp-content/themes/twentyfourteen/css/ie.css?ver=20131205' type='text/css' media='all' />
<![endif]-->
<link rel='stylesheet' id='github-profile-octicons-css'  href='https://rafaelbiriba.com/wp-content/plugins/github-profile-widget/css/octicons/octicons.css?ver=4.5.3' type='text/css' media='all' />
<link rel='stylesheet' id='github-profile-widget-styles-css'  href='https://rafaelbiriba.com/wp-content/plugins/github-profile-widget/css/widget.css?ver=4.5.3' type='text/css' media='all' />
<link rel='stylesheet' id='A2A_SHARE_SAVE-css'  href='https://rafaelbiriba.com/wp-content/plugins/add-to-any/addtoany.min.css?ver=1.12' type='text/css' media='all' />
<link rel='stylesheet' id='fbSEOStylesheet-css'  href='https://rafaelbiriba.com/wp-content/plugins/seo-facebook-comments/assets/fbseo-style.css?ver=4.5.3' type='text/css' media='all' />
<!-- This site uses the Google Analytics by MonsterInsights plugin v5.5.2 - Universal enabled - https://www.monsterinsights.com/ -->
<script type="text/javascript">
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','__gaTracker');

	__gaTracker('create', 'UA-7346716-1', 'auto');
	__gaTracker('set', 'forceSSL', true);
	__gaTracker('send','pageview');

</script>
<!-- / Google Analytics by MonsterInsights -->
<script type='text/javascript' src='https://rafaelbiriba.com/wp-includes/js/jquery/jquery.js?ver=1.12.4'></script>
<script type='text/javascript' src='https://rafaelbiriba.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<script type='text/javascript' src='https://rafaelbiriba.com/wp-content/plugins/content-slide/js/coin-slider.js?ver=4.5.3'></script>
<link rel='https://api.w.org/' href='https://rafaelbiriba.com/wp-json/' />

 


<script type="text/javascript"><!--
var a2a_config=a2a_config||{},wpa2a={done:false,html_done:false,script_ready:false,script_load:function(){var a=document.createElement('script'),s=document.getElementsByTagName('script')[0];a.type='text/javascript';a.async=true;a.src='https://static.addtoany.com/menu/page.js';s.parentNode.insertBefore(a,s);wpa2a.script_load=function(){};},script_onready:function(){wpa2a.script_ready=true;if(wpa2a.html_done)wpa2a.init();},init:function(){for(var i=0,el,target,targets=wpa2a.targets,length=targets.length;i<length;i++){el=document.getElementById('wpa2a_'+(i+1));target=targets[i];a2a_config.linkname=target.title;a2a_config.linkurl=target.url;a2a_config.linkmedia=target.media;if(el){a2a.init('page',{target:el});el.id='';}wpa2a.done=true;}wpa2a.targets=[];}};a2a_config.callbacks=a2a_config.callbacks||[];a2a_config.callbacks.push({ready:wpa2a.script_onready});a2a_config.templates=a2a_config.templates||{};a2a_localize = {
	Share: "Compartilhar",
	Save: "Salvar",
	Subscribe: "Inscrever",
	Email: "Email",
	Bookmark: "Favoritos",
	ShowAll: "Mostrar tudo",
	ShowLess: "Mostrar menos",
	FindServices: "Procurar servi√ßo(s)",
	FindAnyServiceToAddTo: "Encontrar rapidamente qualquer servi√ßo para",
	PoweredBy: "Servi√ßo fornecido por",
	ShareViaEmail: "Share via email",
	SubscribeViaEmail: "Subscribe via email",
	BookmarkInYourBrowser: "Adicionar aos favoritos",
	BookmarkInstructions: "Press Ctrl+D or \u2318+D to bookmark this page",
	AddToYourFavorites: "Adicionar a favoritos",
	SendFromWebOrProgram: "Send from any email address or email program",
	EmailProgram: "Email program",
	More: "More&#8230;"
};

//--></script>
<script type="text/javascript">
	var $jquery = jQuery.noConflict(); 
	$jquery(document).ready(function() 
	{
		$jquery('#wpcontent_slider').coinslider(
	{ 
	width: 980, 
	height: 370, 
	spw: 7, 
	sph: 5, 
	delay: 3000, 
	sDelay: 30, 
	opacity: 0.7, 
	titleSpeed: 500, 
	effect: 'random', 
	navigation: true, 
	links : true, 
	hoverPause: true });
		});
	</script>
<style type="text/css" media="screen">
		
#wpcontent_slider_container
{
	overflow: hidden; position: relative; padding:0px;margin:0px; text-align:center; width:980px !important;
	height:370px !important;
}
#wpcontent_slider 
{ overflow: hidden; position: relative; font-family:\'Trebuchet MS\', Helvetica, sans-serif;border:0px solid #ffffff; text-align:left;}
#wpcontent_slider a,#wpcontent_slider a img { border: none; text-decoration: none; outline: none; }
#wpcontent_slider h4,#wpcontent_slider h4 a 
{margin: 0px;padding: 0px; font-family: 'Trebuchet MS', Helvetica, sans-serif;
text-decoration:none;font-size: 18px; color:#ffffff;}
#wpcontent_slider .cs-title {width: 100%;padding: 10px; background: #ffffff; color: #000000; font-family: 'Trebuchet MS', Helvetica, sans-serif; font-size: 12px; letter-spacing: normal;line-height: normal;}
#wpcontent_slider_container .cs-prev,#wpcontent_slider_container .cs-next {font-weight: bold;background: #000000;
font-size: 28px; font-family: "Courier New", Courier, monospace; color: #ffffff !important;
padding: 0px 10px;-moz-border-radius: 5px;-khtml-border-radius: 5px;-webkit-border-radius: 5px;}
#wpcontent_slider_container .cs-buttons { font-size: 0px; padding: 10px 0px 10px 0px;
margin:0px auto; float:left;clear:left;
}
#wpcontent_slider_container .cs-buttons a { outline:none; margin-left: 5px; height: 10px; width: 10px; float: left; border: 1px solid #000000; color: #000000; text-indent: -1000px; 
}
#wpcontent_slider_container .cs-active { background-color: #000000; color: #FFFFFF; }
#wpcs_link_love,#wpcs_link_love a{display:none;}
</style>
<!-- End Content Slider Settings -->


		<style type="text/css">
			.cbd {
				position: fixed;
				left: 5px;
				bottom: 5px;
			}
			.cbd a img {
				border: 0;
			}
		</style>
	<meta property='fb:admins' content='1644160548' /><meta property='og:title' content='' /><meta property='og:site_name' content='Rafael Biriba Blog' /><meta property='og:url' content='https://rafaelbiriba.com/2010/11/18/net-sftp-calculando-o-progresso-do-upload.html' /><meta property='og:type' content='article' /><meta property='fb:app_id' content='589867447707428'>
	<link rel="stylesheet" href="https://rafaelbiriba.com/wp-content/plugins/shutter-reloaded/shutter-reloaded.css?ver=2.4" type="text/css" media="screen" />
	<style type='text/css'>
div#shNavBar a {color: #000000;}
div#shNavBar {background-color:#ffff00;}
div#shNavBar {color:#000000;}
div#shDisplay div#shTitle {color:#ffff00;}
</style>
<script type="text/javascript">
	window._wp_rp_static_base_url = 'https://wprp.zemanta.com/static/';
	window._wp_rp_wp_ajax_url = "https://rafaelbiriba.com/wp-admin/admin-ajax.php";
	window._wp_rp_plugin_version = '3.6';
	window._wp_rp_post_id = '2337';
	window._wp_rp_num_rel_posts = '5';
	window._wp_rp_thumbnails = false;
	window._wp_rp_post_title = 'Net-SFTP%3A+Calculando+o+progresso+do+upload';
	window._wp_rp_post_tags = ['codigo', 'rubygems', 'desenvolvimento', 'sftp', 'net-sftp', 'upload', 'net-ssh', 'progress', 'progresso', 'ruby', 'desenvolvimento', 'ruby', 'byte', 'gt', 'valor', 'ess', 'de', 'da', 'event', 'voc', 'progresso', 'data', 'write', 'local', 'os', 'durant', 'metadata'];
	window._wp_rp_promoted_content = true;
</script>
<script type="text/javascript" src="https://wprp.zemanta.com/static/js/loader.js?version=3.6" async></script>
</head>

<body class="archive tag tag-upload tag-348 masthead-fixed list-view">
<div id="page" class="hfeed site">
	
	<header id="masthead" class="site-header" role="banner">
		<div class="header-main">
			<h1 class="site-title"><a href="https://rafaelbiriba.com/blogwp.html" rel="home">Rafael Biriba Blog</a></h1>

			<div class="search-toggle">
				<a href="#search-container" class="screen-reader-text" aria-expanded="false" aria-controls="search-container">Pesquisar</a>
			</div>

			<nav id="primary-navigation" class="site-navigation primary-navigation" role="navigation">
				<button class="menu-toggle">Menu principal</button>
				<a class="screen-reader-text skip-link" href="#content">Pular para o conte√∫do</a>
				<div id="primary-menu" class="nav-menu"><ul><li class="page_item page-item-3171"><a href="https://rafaelbiriba.com/search_gcse">Busca</a></li><li class="page_item page-item-101"><a href="https://rafaelbiriba.com/contatos">Contatos</a></li><li class="page_item page-item-1251"><a href="https://rafaelbiriba.com/twitter">Twitter</a></li></ul></div>
			</nav>
		</div>

		<div id="search-container" class="search-box-wrapper hide">
			<div class="search-box">
				<form role="search" method="get"
    class="search-form" action="https://rafaelbiriba.com//search_gcse">
    <div>
        <label class="screen-reader-text" for="s"></label>
        <input type="text" value="" name="q" id="q" />
        <input type="submit" id="searchsubmit"
            value="Pesquisar" />
    </div>
</form>
			</div>
		</div>
	</header><!-- #masthead -->

	<div id="main" class="site-main">

	<section id="primary" class="content-area">
		<div id="content" class="site-content" role="main">

			
			<header class="archive-header">
				<h1 class="archive-title">Arquivo da tag: upload</h1>

							</header><!-- .archive-header -->

			
<article id="post-2337" class="post-2337 post type-post status-publish format-standard hentry category-desenvolvimento category-ruby tag-codigo tag-desenvolvimento tag-net-sftp tag-net-ssh tag-progress tag-progresso tag-ruby tag-rubygems tag-sftp tag-upload">
	
	<header class="entry-header">
				<div class="entry-meta">
			<span class="cat-links"><a href="https://rafaelbiriba.com/category/desenvolvimento" rel="category tag">Desenvolvimento</a>, <a href="https://rafaelbiriba.com/category/desenvolvimento/ruby" rel="category tag">Ruby</a></span>
		</div>
		<h1 class="entry-title"><a href="https://rafaelbiriba.com/2010/11/18/net-sftp-calculando-o-progresso-do-upload.html" rel="bookmark">Net-SFTP: Calculando o progresso do upload</a></h1>
		<div class="entry-meta">
			<span class="entry-date"><a href="https://rafaelbiriba.com/2010/11/18/net-sftp-calculando-o-progresso-do-upload.html" rel="bookmark"><time class="entry-date" datetime="2010-11-18T10:40:29+00:00">18/11/2010</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://rafaelbiriba.com/author/rafael" rel="author">Rafael Biriba</a></span></span>			<span class="comments-link"><a href="https://rafaelbiriba.com/2010/11/18/net-sftp-calculando-o-progresso-do-upload.html#comments"><span class="dsq-postid" data-dsqidentifier="2337 https://rafaelbiriba.com/?p=2337">2 Coment√°rios</span></a></span>
					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		
<p style="text-align: justify;"><a href="https://rafaelbiriba.com/wp-content/uploads/2010/09/ruby-box.png"><img class="alignright size-full wp-image-2273" title="ruby-box" src="https://rafaelbiriba.com/wp-content/uploads/2010/09/ruby-box.png" alt="" width="150" height="150" /></a>Estou escrevendo esse post, para complementar o <a title="https://rafaelbiriba.com/2010/09/24/problema-no-net-sftp-timeout-para-o-upload.html" href="https://rafaelbiriba.com/2010/09/24/problema-no-net-sftp-timeout-para-o-upload.html" target="_blank">post sobre o timeout do net-sftp</a>, onde fiquei devendo essa a solu√ß√£o de calculo do progresso&#8230;</p>
<p style="text-align: justify;">Para obter o progresso durante o upload, voc√™ precisa usar o callback do m√©todo upload! e jogar numa vari√°vel os valores do tamanho local e do tamanho do arquivo no destino.</p>
<p style="text-align: justify;">Vejamos um pequeno exemplo, retirado da <a title="http://net-ssh.rubyforge.org/sftp/v2/api/classes/Net/SFTP/Operations/Upload.html" href="http://net-ssh.rubyforge.org/sftp/v2/api/classes/Net/SFTP/Operations/Upload.html" target="_blank">documenta√ß√£o</a>:</p>


<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre class="ruby" style="font-family:monospace;"><span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'rubygems'</span>
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'net/sftp'</span>
<span style="color:#6666ff; font-weight:bold;">Net::SFTP</span>.<span style="color:#9900CC;">start</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">'192.168.0.2'</span>, <span style="color:#996600;">'rafaelbiriba'</span>, <span style="color:#006600; font-weight:bold;">&#123;</span>:password <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#996600;">'teste'</span>, <span style="color:#ff3333; font-weight:bold;">:timeout</span> <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#006666;">3</span><span style="color:#006600; font-weight:bold;">&#125;</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#9966CC; font-weight:bold;">do</span> <span style="color:#006600; font-weight:bold;">|</span>sftp<span style="color:#006600; font-weight:bold;">|</span>
  sftp.<span style="color:#9900CC;">upload</span>!<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;/Users/rafaelbiriba/Projects/temp/video-teste-sftp.mp4&quot;</span>, <span style="color:#996600;">&quot;/home/rafaelbiriba/video-teste-sftp.mp4&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#9966CC; font-weight:bold;">do</span> <span style="color:#006600; font-weight:bold;">|</span>event, uploader, <span style="color:#006600; font-weight:bold;">*</span>args<span style="color:#006600; font-weight:bold;">|</span>
    <span style="color:#9966CC; font-weight:bold;">case</span> event
    <span style="color:#9966CC; font-weight:bold;">when</span> :<span style="color:#CC0066; font-weight:bold;">open</span> <span style="color:#9966CC; font-weight:bold;">then</span>
      <span style="color:#008000; font-style:italic;"># args[0] : file metadata</span>
      <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;starting upload: #{args[0].local} -&gt; #{args[0].remote} (#{args[0].size} bytes}&quot;</span>
    <span style="color:#9966CC; font-weight:bold;">when</span> <span style="color:#ff3333; font-weight:bold;">:put</span> <span style="color:#9966CC; font-weight:bold;">then</span>
      <span style="color:#008000; font-style:italic;"># args[0] : file metadata</span>
      <span style="color:#008000; font-style:italic;"># args[1] : byte offset in remote file</span>
      <span style="color:#008000; font-style:italic;"># args[2] : data being written (as string)</span>
      <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;writing #{args[2].length} bytes to #{args[0].remote} starting at #{args[1]}&quot;</span>
    <span style="color:#9966CC; font-weight:bold;">when</span> <span style="color:#ff3333; font-weight:bold;">:finish</span> <span style="color:#9966CC; font-weight:bold;">then</span>
      <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;all done!&quot;</span>
    <span style="color:#9966CC; font-weight:bold;">end</span>
  <span style="color:#9966CC; font-weight:bold;">end</span>
<span style="color:#9966CC; font-weight:bold;">end</span></pre></td></tr></table></div>



<p style="text-align: justify;">No exemplo acima podemos verificar:</p>
<ul style="text-align: justify;">
	<li>Ao abrir a conex√£o (when open), podemos chamar <strong>args[0].size</strong> e obter o tamanho total do arquivo</li>
	<li>Durante a transfer√™ncia (when put), ao chamar <strong>args[1]</strong> podemos obter o tamanho do arquivo remoto</li>
</ul>
<p style="text-align: justify;">Com isso, quando o tamanho total do arquivo for igual ao tamanho do arquivo remoto, ent√£o o upload estar√° terminado (100%). Para obter as porcentagens, basta fazer o c√°lculo.<br /><br />Confira no exemplo abaixo:</p>


<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="code"><pre class="ruby" style="font-family:monospace;"><span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'rubygems'</span>
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'net/sftp'</span>
<span style="color:#0066ff; font-weight:bold;">@total_size</span> = <span style="color:#006666;">0</span>
<span style="color:#0066ff; font-weight:bold;">@remote_size</span> = <span style="color:#006666;">0</span>
<span style="color:#0066ff; font-weight:bold;">@current_progress</span> = <span style="color:#006666;">0</span>
&nbsp;
<span style="color:#9966CC; font-weight:bold;">def</span> update_sftp_progress
  progress = <span style="color:#006600; font-weight:bold;">&#40;</span>@remote_size<span style="color:#006600; font-weight:bold;">*</span><span style="color:#006666;">100</span><span style="color:#006600; font-weight:bold;">&#41;</span><span style="color:#006600; font-weight:bold;">/</span>@total_size<span style="color:#006600; font-weight:bold;">&#41;</span>
  <span style="color:#9966CC; font-weight:bold;">if</span> <span style="color:#0066ff; font-weight:bold;">@current_progress</span> <span style="color:#006600; font-weight:bold;">&lt;</span> progress <span style="color:#9966CC; font-weight:bold;">then</span>
    <span style="color:#0066ff; font-weight:bold;">@current_progress</span> = progress
    <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;Uploading: #{@current_progress}%&quot;</span> 
  <span style="color:#9966CC; font-weight:bold;">end</span>
<span style="color:#9966CC; font-weight:bold;">end</span>
&nbsp;
<span style="color:#6666ff; font-weight:bold;">Net::SFTP</span>.<span style="color:#9900CC;">start</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">'192.168.0.2'</span>, <span style="color:#996600;">'rafaelbiriba'</span>, <span style="color:#006600; font-weight:bold;">&#123;</span>:password <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#996600;">'teste'</span>, <span style="color:#ff3333; font-weight:bold;">:timeout</span> <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#006666;">3</span><span style="color:#006600; font-weight:bold;">&#125;</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#9966CC; font-weight:bold;">do</span> <span style="color:#006600; font-weight:bold;">|</span>sftp<span style="color:#006600; font-weight:bold;">|</span>
 sftp.<span style="color:#9900CC;">upload</span>!<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;/Users/rafaelbiriba/Projects/temp/video-teste-sftp.mp4&quot;</span>, <span style="color:#996600;">&quot;/home/rafaelbiriba/video-teste-sftp.mp4&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#9966CC; font-weight:bold;">do</span> <span style="color:#006600; font-weight:bold;">|</span>event, uploader, <span style="color:#006600; font-weight:bold;">*</span>args<span style="color:#006600; font-weight:bold;">|</span>
   <span style="color:#9966CC; font-weight:bold;">case</span> event
     <span style="color:#9966CC; font-weight:bold;">when</span> :<span style="color:#CC0066; font-weight:bold;">open</span> <span style="color:#9966CC; font-weight:bold;">then</span>
       <span style="color:#0066ff; font-weight:bold;">@total_size</span> = args<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#006666;">0</span><span style="color:#006600; font-weight:bold;">&#93;</span>.<span style="color:#9900CC;">size</span>
       <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;Starting upload...&quot;</span>
     <span style="color:#9966CC; font-weight:bold;">when</span> <span style="color:#ff3333; font-weight:bold;">:put</span> <span style="color:#9966CC; font-weight:bold;">then</span>
       <span style="color:#0066ff; font-weight:bold;">@remote_size</span> = args<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#006666;">1</span><span style="color:#006600; font-weight:bold;">&#93;</span>
       update_sftp_progress
     <span style="color:#9966CC; font-weight:bold;">when</span> <span style="color:#ff3333; font-weight:bold;">:finish</span> <span style="color:#9966CC; font-weight:bold;">then</span>
       <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;Finished!&quot;</span>
     <span style="color:#9966CC; font-weight:bold;">end</span>
   <span style="color:#9966CC; font-weight:bold;">end</span>
<span style="color:#9966CC; font-weight:bold;">end</span></pre></td></tr></table></div>



<p style="text-align: justify;">Toda vez que o arquivo no destino for incrementado, o evento (:put) ser√° disparado, chamando o m√©todo update_sftp_progress.</p>
<p style="text-align: justify;">Nesse m√©todo √© feito o c√°lculo da porcentagem(ver no exemplo acima). Ao inv√©s de imprimir a porcentagem(com puts), voc√™ tamb√©m pode salvar no banco de dados, ou utilizar o valor para fazer uma barra de progresso.</p>
<p style="text-align: justify;">Espero ter ajudado, üòâ</p>
<div class="addtoany_share_save_container addtoany_content_bottom"><div class="a2a_kit a2a_kit_size_32 addtoany_list a2a_target" id="wpa2a_1"><a class="a2a_button_facebook_like addtoany_special_service" data-href="https://rafaelbiriba.com/2010/11/18/net-sftp-calculando-o-progresso-do-upload.html"></a><a class="a2a_button_twitter_tweet addtoany_special_service" data-url="https://rafaelbiriba.com/2010/11/18/net-sftp-calculando-o-progresso-do-upload.html" data-text="Net-SFTP: Calculando o progresso do upload"></a><a class="a2a_button_twitter" href="http://www.addtoany.com/add_to/twitter?linkurl=http%3A%2F%2Fwww.rafaelbiriba.com%2F2010%2F11%2F18%2Fnet-sftp-calculando-o-progresso-do-upload.html&amp;linkname=Net-SFTP%3A%20Calculando%20o%20progresso%20do%20upload" title="Twitter" rel="nofollow" target="_blank"></a><a class="a2a_button_facebook" href="http://www.addtoany.com/add_to/facebook?linkurl=http%3A%2F%2Fwww.rafaelbiriba.com%2F2010%2F11%2F18%2Fnet-sftp-calculando-o-progresso-do-upload.html&amp;linkname=Net-SFTP%3A%20Calculando%20o%20progresso%20do%20upload" title="Facebook" rel="nofollow" target="_blank"></a><a class="a2a_dd addtoany_share_save" href="https://www.addtoany.com/share"><img src="https://rafaelbiriba.com/wp-content/plugins/add-to-any/share_save_171_16.png" width="171" height="16" alt="Share"/></a>
<script type="text/javascript"><!--
if(wpa2a)wpa2a.script_load();
//--></script>
</div></div>	</div><!-- .entry-content -->
	
	<footer class="entry-meta"><span class="tag-links"><a href="https://rafaelbiriba.com/tag/codigo" rel="tag">codigo</a><a href="https://rafaelbiriba.com/tag/desenvolvimento" rel="tag">Desenvolvimento</a><a href="https://rafaelbiriba.com/tag/net-sftp" rel="tag">net-sftp</a><a href="https://rafaelbiriba.com/tag/net-ssh" rel="tag">net-ssh</a><a href="https://rafaelbiriba.com/tag/progress" rel="tag">progress</a><a href="https://rafaelbiriba.com/tag/progresso" rel="tag">progresso</a><a href="https://rafaelbiriba.com/tag/ruby" rel="tag">Ruby</a><a href="https://rafaelbiriba.com/tag/rubygems" rel="tag">rubygems</a><a href="https://rafaelbiriba.com/tag/sftp" rel="tag">sftp</a><a href="https://rafaelbiriba.com/tag/upload" rel="tag">upload</a></span></footer></article><!-- #post-## -->

<article id="post-2271" class="post-2271 post type-post status-publish format-standard hentry category-desenvolvimento category-ruby tag-codigo tag-conexao tag-connection tag-desenvolvimento tag-net-sftp tag-net-ssh tag-ruby tag-rubygems tag-rufus tag-scheduler tag-timeout tag-upload">
	
	<header class="entry-header">
				<div class="entry-meta">
			<span class="cat-links"><a href="https://rafaelbiriba.com/category/desenvolvimento" rel="category tag">Desenvolvimento</a>, <a href="https://rafaelbiriba.com/category/desenvolvimento/ruby" rel="category tag">Ruby</a></span>
		</div>
		<h1 class="entry-title"><a href="https://rafaelbiriba.com/2010/09/24/problema-no-net-sftp-timeout-para-o-upload.html" rel="bookmark">Net-sftp: Solu√ß√£o para timeout durante o upload</a></h1>
		<div class="entry-meta">
			<span class="entry-date"><a href="https://rafaelbiriba.com/2010/09/24/problema-no-net-sftp-timeout-para-o-upload.html" rel="bookmark"><time class="entry-date" datetime="2010-09-24T11:15:22+00:00">24/09/2010</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://rafaelbiriba.com/author/rafael" rel="author">Rafael Biriba</a></span></span>			<span class="comments-link"><a href="https://rafaelbiriba.com/2010/09/24/problema-no-net-sftp-timeout-para-o-upload.html#comments"><span class="dsq-postid" data-dsqidentifier="2271 https://rafaelbiriba.com/?p=2271">5 Coment√°rios</span></a></span>
					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		
<p style="text-align: justify;"><img class="alignleft size-full wp-image-2273" title="ruby-box" src="https://rafaelbiriba.com/wp-content/uploads/2010/09/ruby-box.png" alt="" width="150" height="150" /></p>
<p style="text-align: justify;">Desenvolvendo um script em ruby para upload de arquivos, utilizando a gem <a title="http://rubygems.org/gems/net-sftp" href="http://rubygems.org/gems/net-sftp" target="_blank">net-sftp</a>, acabei encontrando um problema. A falta de timeout durante a transfer√™ncia.</p>
<p style="text-align: justify;">Decidi escrever esse post, para compartilhar a minha solu√ß√£o e tamb√©m receber opni√µes e outras solu√ß√µes para o problema. Fiz algo parecido quando escrevi o post sobre o <a title="https://rafaelbiriba.com/2010/08/01/crontab-rodando-um-script-a-cada-15-segundos.html" href="https://rafaelbiriba.com/2010/08/01/crontab-rodando-um-script-a-cada-15-segundos.html" target="_blank">cron de 15 em 15 segundos</a> e obtive resultados bem legais.</p>
<p style="text-align: justify;"><strong>Introdu√ß√£o ao problema<br /></strong>A gem <a title="http://rubygems.org/gems/net-sftp" href="http://rubygems.org/gems/net-sftp" target="_blank">net-sftp</a> √© bastante utilizada em scripts ruby que requerem alguma transfer√™ncia de arquivo utilizando uma conex√£o segura, como por exemplo, upload, download, cria√ß√£o de diret√≥rios e etc&#8230; Utilizando a gem <a title="http://rubygems.org/gems/net-ssh" href="http://rubygems.org/gems/net-ssh" target="_blank">net-ssh</a> para estabelecer essa conex√£o.</p>
<p style="text-align: justify;">Primeiramente, vamor ver um exemplo do problema:</p>


<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
</pre></td><td class="code"><pre class="ruby" style="font-family:monospace;"><span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'rubygems'</span>
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'net/sftp'</span>
<span style="color:#6666ff; font-weight:bold;">Net::SFTP</span>.<span style="color:#9900CC;">start</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">'192.168.0.2'</span>, <span style="color:#996600;">'rafaelbiriba'</span>, <span style="color:#006600; font-weight:bold;">&#123;</span>:password <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#996600;">'teste'</span>, <span style="color:#ff3333; font-weight:bold;">:timeout</span> <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#006666;">3</span><span style="color:#006600; font-weight:bold;">&#125;</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#9966CC; font-weight:bold;">do</span> <span style="color:#006600; font-weight:bold;">|</span>sftp<span style="color:#006600; font-weight:bold;">|</span>
  sftp.<span style="color:#9900CC;">upload</span>!<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;/Users/rafaelbiriba/Projects/temp/video-teste-sftp.mp4&quot;</span>, <span style="color:#996600;">&quot;/home/rafaelbiriba/video-teste-sftp.mp4&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
<span style="color:#9966CC; font-weight:bold;">end</span></pre></td></tr></table></div>



<p style="text-align: justify;">O c√≥digo acima faz o upload de um arquivo de mais de 400 Mb. Se durante o upload houver um problema na sua conex√£o, o upload fica &#8220;esperando&#8221; a rede voltar, o que √© um problem√£o, pois ele trava a execu√ß√£o do script, sem dar nenhum sinal de vida.</p>
<p style="text-align: justify;">De acordo com a <a title="http://net-ssh.rubyforge.org/sftp/v2/api/classes/Net/SFTP/Session.html#M000115" href="http://net-ssh.rubyforge.org/sftp/v2/api/classes/Net/SFTP/Session.html#M000115" target="_blank">documenta√ß√£o do net-sftp</a>, voc√™ pode utilizar o m√©todo &#8220;upload&#8221; no lugar de &#8220;upload!&#8221; para n√£o travar a execu√ß√£o do script. Mas ainda sim o problema continua. Fazendo isso, voc√™ vai precisar rodar um loop at√© que o upload termine. Ou seja, se a conex√£o cair, o m√©todo s√≥ vai terminar(e sair do loop) quando a conex√£o voltar. Ent√£o essa op√ß√£o foi logo descartada.</p>
<p style="text-align: justify;">O problema mesmo s√≥ acontece quando h√° perda de conex√£o depois que a sess√£o inicia. (O par√¢metro :timeout apenas estabelece o limite de espera para iniciar a sess√£o e n√£o durante a transfer√™ncia dos arquivos.)</p>
<p style="text-align: justify;">Se o net-sftp / net-ssh aceitasse a op√ß√£o &#8220;ServerAliveInterval&#8221; (Parametro de configura√ß√£o do ssh), ele iria verificar a conex√£o durante a transfer√™ncia e ao alcan√ßar o limite (&#8220;ServerAliveCountMax&#8221;) seria disparado o timeout. Infelizmente, de acordo com a <a title="http://net-ssh.rubyforge.org/ssh/v2/api/classes/Net/SSH/Config.html" href="http://net-ssh.rubyforge.org/ssh/v2/api/classes/Net/SSH/Config.html" target="_blank">documenta√ß√£o do net-ssh</a> esses par√¢metros n√£o est√£o dispon√≠veis.</p>
<p style="text-align: justify;">Seguindo com a leitura e busca pela solu√ß√£o na <a title="http://net-ssh.rubyforge.org/sftp/v2/api/classes/Net/SFTP/Session.html#M000115" href="http://net-ssh.rubyforge.org/sftp/v2/api/classes/Net/SFTP/Session.html#M000115" target="_blank">documenta√ß√£o do net-sftp</a>, achei uma poss√≠vel pista para encontrar a solu√ß√£o:</p>


<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre class="ruby" style="font-family:monospace;"><span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'rubygems'</span>
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'net/sftp'</span>
<span style="color:#6666ff; font-weight:bold;">Net::SFTP</span>.<span style="color:#9900CC;">start</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">'192.168.0.2'</span>, <span style="color:#996600;">'rafaelbiriba'</span>, <span style="color:#006600; font-weight:bold;">&#123;</span>:password <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#996600;">'teste'</span>, <span style="color:#ff3333; font-weight:bold;">:timeout</span> <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#006666;">3</span><span style="color:#006600; font-weight:bold;">&#125;</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#9966CC; font-weight:bold;">do</span> <span style="color:#006600; font-weight:bold;">|</span>sftp<span style="color:#006600; font-weight:bold;">|</span>
  sftp.<span style="color:#9900CC;">upload</span>!<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;/Users/rafaelbiriba/Projects/temp/video-teste-sftp.mp4&quot;</span>, <span style="color:#996600;">&quot;/home/rafaelbiriba/video-teste-sftp.mp4&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#9966CC; font-weight:bold;">do</span> <span style="color:#006600; font-weight:bold;">|</span>event, uploader, <span style="color:#006600; font-weight:bold;">*</span>args<span style="color:#006600; font-weight:bold;">|</span>
    <span style="color:#9966CC; font-weight:bold;">case</span> event
    <span style="color:#9966CC; font-weight:bold;">when</span> :<span style="color:#CC0066; font-weight:bold;">open</span> <span style="color:#9966CC; font-weight:bold;">then</span>
      <span style="color:#008000; font-style:italic;"># args[0] : file metadata</span>
      <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;starting upload: #{args[0].local} -&gt; #{args[0].remote} (#{args[0].size} bytes}&quot;</span>
    <span style="color:#9966CC; font-weight:bold;">when</span> <span style="color:#ff3333; font-weight:bold;">:put</span> <span style="color:#9966CC; font-weight:bold;">then</span>
      <span style="color:#008000; font-style:italic;"># args[0] : file metadata</span>
      <span style="color:#008000; font-style:italic;"># args[1] : byte offset in remote file</span>
      <span style="color:#008000; font-style:italic;"># args[2] : data being written (as string)</span>
      <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;writing #{args[2].length} bytes to #{args[0].remote} starting at #{args[1]}&quot;</span>
    <span style="color:#9966CC; font-weight:bold;">when</span> <span style="color:#ff3333; font-weight:bold;">:finish</span> <span style="color:#9966CC; font-weight:bold;">then</span>
      <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;all done!&quot;</span>
    <span style="color:#9966CC; font-weight:bold;">end</span>
  <span style="color:#9966CC; font-weight:bold;">end</span>
<span style="color:#9966CC; font-weight:bold;">end</span></pre></td></tr></table></div>



<p style="text-align: justify;">Acima temos um exemplo simples retirado da <a title="http://net-ssh.rubyforge.org/sftp/v2/api/classes/Net/SFTP/Operations/Upload.html" href="http://net-ssh.rubyforge.org/sftp/v2/api/classes/Net/SFTP/Operations/Upload.html" target="_blank">documenta√ß√£o</a> para o controle do progresso de upload.</p>
<p style="text-align: justify;">Quando o upload inicia, o case recebe o evento &#8220;:open&#8221; onde podemos obter o tamanho total do arquivo e logo em seguida recebe os eventos &#8220;:put&#8221; onde √© poss√≠vel verificar¬† o quanto (em bytes) do arquivo j√° foi enviado, possibilitando assim a cria√ß√£o da porcentagem do upload.</p>
<p style="text-align: justify;">Como o foco aqui n√£o √© mostrar como obter o progresso (<span style="text-decoration: line-through;">posso mostrar isso exclusivamente em outro post</span> <a title="https://rafaelbiriba.com/2010/11/18/net-sftp-calculando-o-progresso-do-upload.html" href="https://rafaelbiriba.com/2010/11/18/net-sftp-calculando-o-progresso-do-upload.html" target="_blank">calculando o progresso durante o upload</a>), n√£o vou entrar muito em detalhes sobre isso. O que realmente inporta nesses eventos s√£o que durante o upload (:put), ao perder a conex√£o, nenhum evento √© disparado, ou seja, o script n√£o tem como sabe que a conex√£o caiu e a execu√ß√£o fica travada no upload.</p>
<p style="text-align: justify;"><strong>Minha solu√ß√£o:</strong></p>
<p style="text-align: justify;">Depois de todo esse estudo detalhado sobre o problema, comecei a pensar numa poss√≠vel solu√ß√£o. Eu precisava utilizar alguma coisa que pudesse verificar e dar timeout no upload caso ele parasse de responder/transferir.</p>
<p style="text-align: justify;">Foi ent√£o que <span style="text-decoration: line-through;">pesquisei</span>, testei e implementei o <a title="http://rubygems.org/gems/rufus-scheduler" href="http://rubygems.org/gems/rufus-scheduler" target="_blank">rufus-scheduler</a>*,¬† um agendador de tarefas que roda dentro do script ruby(mas numa outra thread), onde posso definir um intervalo de execu√ß√£o para executar alguma coisa, como se fosse um cron. ( *Sugest√£o do <a title="http://twitter.com/vicentemundim" href="http://twitter.com/vicentemundim" target="_blank">@vicentemundim</a> )</p>
<p style="text-align: justify;"><strong>Ent√£o a solu√ß√£o foi:</strong> Assim que o upload come√ßar, eu defino um tempo de 10 segundos para ele executar uma tarefa com &#8220;raise exception&#8221;. Ent√£o toda vez que o upload responder ao evento (:put), informando que conseguiu subir mais um trecho do arquivo, eu reseto o tempo de execu√ß√£o da tarefa e defino novamente em 10 segundos. Fazendo isso, quando a conex√£o cair ou o upload travar por algum motivo, ele vai parar de responder ao evento &#8220;:put&#8221;, e ent√£o a tarefa agendada para 10 segundos vai disparar o raise, interrompendo a execu√ß√£o do script.</p>
<p style="text-align: justify;">Depois de alguns testes, tanto de desempenho quanto de falhas, percebi que essa resolu√ß√£o serviu perfeitamente. Segue o exemplo do c√≥digo utilizado:</p>


<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre class="ruby" style="font-family:monospace;"><span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'rubygems'</span>
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'rufus/scheduler'</span>
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'net/sftp'</span>
&nbsp;
<span style="color:#0066ff; font-weight:bold;">@job</span> = <span style="color:#0000FF; font-weight:bold;">nil</span>
<span style="color:#0066ff; font-weight:bold;">@scheduler</span> = <span style="color:#6666ff; font-weight:bold;">Rufus::Scheduler::PlainScheduler</span>.<span style="color:#9900CC;">start_new</span>  
<span style="color:#9966CC; font-weight:bold;">def</span> <span style="color:#0066ff; font-weight:bold;">@scheduler</span>.<span style="color:#9900CC;">handle_exception</span> <span style="color:#006600; font-weight:bold;">&#40;</span>job, exception<span style="color:#006600; font-weight:bold;">&#41;</span>
  abort<span style="color:#006600; font-weight:bold;">&#40;</span>exception.<span style="color:#9900CC;">message</span><span style="color:#006600; font-weight:bold;">&#41;</span>
<span style="color:#9966CC; font-weight:bold;">end</span>
&nbsp;
<span style="color:#9966CC; font-weight:bold;">def</span> job_scheduler
  <span style="color:#0066ff; font-weight:bold;">@job</span>.<span style="color:#9900CC;">unschedule</span> <span style="color:#9966CC; font-weight:bold;">unless</span> <span style="color:#0066ff; font-weight:bold;">@job</span>.<span style="color:#0000FF; font-weight:bold;">nil</span>?
  <span style="color:#0066ff; font-weight:bold;">@job</span> = <span style="color:#0066ff; font-weight:bold;">@scheduler</span>.<span style="color:#9900CC;">every</span> <span style="color:#996600;">&quot;10s&quot;</span> <span style="color:#9966CC; font-weight:bold;">do</span>
    <span style="color:#CC0066; font-weight:bold;">raise</span> <span style="color:#996600;">&quot;SFTP Connection Lost or upload freezed timeout&quot;</span>
  <span style="color:#9966CC; font-weight:bold;">end</span>    
<span style="color:#9966CC; font-weight:bold;">end</span>
&nbsp;
<span style="color:#6666ff; font-weight:bold;">Net::SFTP</span>.<span style="color:#9900CC;">start</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">'192.168.0.2'</span>, <span style="color:#996600;">'rafaelbiriba'</span>, <span style="color:#006600; font-weight:bold;">&#123;</span>:password <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#996600;">'teste'</span>, <span style="color:#ff3333; font-weight:bold;">:timeout</span> <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#006666;">3</span><span style="color:#006600; font-weight:bold;">&#125;</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#9966CC; font-weight:bold;">do</span> <span style="color:#006600; font-weight:bold;">|</span>sftp<span style="color:#006600; font-weight:bold;">|</span>
  sftp.<span style="color:#9900CC;">upload</span>!<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;/Users/rafaelbiriba/Projects/temp/video-teste-sftp.mp4&quot;</span>, <span style="color:#996600;">&quot;/home/rafaelbiriba/video-teste-sftp.mp4&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#9966CC; font-weight:bold;">do</span> <span style="color:#006600; font-weight:bold;">|</span>event, uploader, <span style="color:#006600; font-weight:bold;">*</span>args<span style="color:#006600; font-weight:bold;">|</span>
    <span style="color:#9966CC; font-weight:bold;">case</span> event
    <span style="color:#9966CC; font-weight:bold;">when</span> :<span style="color:#CC0066; font-weight:bold;">open</span> <span style="color:#9966CC; font-weight:bold;">then</span>
      <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;starting upload: #{args[0].local} -&gt; #{args[0].remote} (#{args[0].size} bytes}&quot;</span>
      job_scheduler
    <span style="color:#9966CC; font-weight:bold;">when</span> <span style="color:#ff3333; font-weight:bold;">:put</span> <span style="color:#9966CC; font-weight:bold;">then</span>
      <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;writing #{args[2].length} bytes to #{args[0].remote} starting at #{args[1]}&quot;</span>
      job_scheduler
    <span style="color:#9966CC; font-weight:bold;">when</span> <span style="color:#ff3333; font-weight:bold;">:finish</span> <span style="color:#9966CC; font-weight:bold;">then</span>
      <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;all done!&quot;</span>
     <span style="color:#0066ff; font-weight:bold;">@job</span>.<span style="color:#9900CC;">unschedule</span> <span style="color:#9966CC; font-weight:bold;">unless</span> <span style="color:#0066ff; font-weight:bold;">@job</span>.<span style="color:#0000FF; font-weight:bold;">nil</span>? 
    <span style="color:#9966CC; font-weight:bold;">end</span>
  <span style="color:#9966CC; font-weight:bold;">end</span>
<span style="color:#9966CC; font-weight:bold;">end</span></pre></td></tr></table></div>



<p style="text-align: justify;">Quando o upload inicia (:open) e durante a transfer√™ncia (:put), ele chama o m√©todo job_scheduler que √© respons√°vel por resetar a tarefa anterior(se houver) e agendar uma nova com timeout de 10 segundos.</p>
<p style="text-align: justify;">Conforme expliquei acima, se o upload travar, o tempo limite de 10 segundos √© alcan√ßado e uma exce√ß√£o √© disparada.</p>
<p style="text-align: justify;">Como o agendador do rufus roda em outra thread, qualquer exce√ß√£o disparada √© capturada e tratada pelo pr√≥prio rufus, fazendo com que a execu√ß√£o do script continue. Ent√£o, sobrescrevi o m√©todo (handle_exception) e ao receber a exce√ß√£o, gero um abort que ir√° interromper todo o script.</p>
<p style="text-align: justify;">Infelizmente, s√£o poucos os sites relacionados sobre esse assunto, o que dificultou bastante a busca e o desenvolvimento. Mesmo assim, acredito ter resolvido o problema com uma solu√ß√£o bem razo√°vel.</p>
<p style="text-align: justify;">J√° falei em cima, mas vale ressaltar:<br />&#8220;Decidi escrever esse post, para compartilhar a minha solu√ß√£o e tamb√©m  receber opni√µes e outras solu√ß√µes para o problema. Fiz algo parecido  quando escrevi o post sobre o <a title="https://rafaelbiriba.com/2010/08/01/crontab-rodando-um-script-a-cada-15-segundos.html" href="https://rafaelbiriba.com/2010/08/01/crontab-rodando-um-script-a-cada-15-segundos.html" target="_blank">cron de 15 em 15 segundos</a> e obtive resultados bem legais.&#8221;</p>
<p style="text-align: justify;">Estou pensando em tentar solucionar isso direto no c√≥digo do net-sftp e quem sabe mandar um patch para o autor. De qualquer forma, fico no aguardo de qualquer coment√°rio e/ou solu√ß√µes melhores.</p>
<div id="_mcePaste" style="position: absolute; left: -10000px; top: 1775px; width: 1px; height: 1px; overflow: hidden;">


<div class="wp_syntax"><table><tr><td class="code"><pre class="ruby" style="font-family:monospace;">handle_exception</pre></td></tr></table></div>



</div>
<div class="addtoany_share_save_container addtoany_content_bottom"><div class="a2a_kit a2a_kit_size_32 addtoany_list a2a_target" id="wpa2a_2"><a class="a2a_button_facebook_like addtoany_special_service" data-href="https://rafaelbiriba.com/2010/09/24/problema-no-net-sftp-timeout-para-o-upload.html"></a><a class="a2a_button_twitter_tweet addtoany_special_service" data-url="https://rafaelbiriba.com/2010/09/24/problema-no-net-sftp-timeout-para-o-upload.html" data-text="Net-sftp: Solu√ß√£o para timeout durante o upload"></a><a class="a2a_button_twitter" href="http://www.addtoany.com/add_to/twitter?linkurl=http%3A%2F%2Fwww.rafaelbiriba.com%2F2010%2F09%2F24%2Fproblema-no-net-sftp-timeout-para-o-upload.html&amp;linkname=Net-sftp%3A%20Solu%C3%A7%C3%A3o%20para%20timeout%20durante%20o%20upload" title="Twitter" rel="nofollow" target="_blank"></a><a class="a2a_button_facebook" href="http://www.addtoany.com/add_to/facebook?linkurl=http%3A%2F%2Fwww.rafaelbiriba.com%2F2010%2F09%2F24%2Fproblema-no-net-sftp-timeout-para-o-upload.html&amp;linkname=Net-sftp%3A%20Solu%C3%A7%C3%A3o%20para%20timeout%20durante%20o%20upload" title="Facebook" rel="nofollow" target="_blank"></a><a class="a2a_dd addtoany_share_save" href="https://www.addtoany.com/share"><img src="https://rafaelbiriba.com/wp-content/plugins/add-to-any/share_save_171_16.png" width="171" height="16" alt="Share"/></a></div></div>	</div><!-- .entry-content -->
	
	<footer class="entry-meta"><span class="tag-links"><a href="https://rafaelbiriba.com/tag/codigo" rel="tag">codigo</a><a href="https://rafaelbiriba.com/tag/conexao" rel="tag">conex√£o</a><a href="https://rafaelbiriba.com/tag/connection" rel="tag">connection</a><a href="https://rafaelbiriba.com/tag/desenvolvimento" rel="tag">Desenvolvimento</a><a href="https://rafaelbiriba.com/tag/net-sftp" rel="tag">net-sftp</a><a href="https://rafaelbiriba.com/tag/net-ssh" rel="tag">net-ssh</a><a href="https://rafaelbiriba.com/tag/ruby" rel="tag">Ruby</a><a href="https://rafaelbiriba.com/tag/rubygems" rel="tag">rubygems</a><a href="https://rafaelbiriba.com/tag/rufus" rel="tag">rufus</a><a href="https://rafaelbiriba.com/tag/scheduler" rel="tag">scheduler</a><a href="https://rafaelbiriba.com/tag/timeout" rel="tag">timeout</a><a href="https://rafaelbiriba.com/tag/upload" rel="tag">upload</a></span></footer></article><!-- #post-## -->
		</div><!-- #content -->
	</section><!-- #primary -->

<div id="content-sidebar" class="content-sidebar widget-area" role="complementary">
	<aside id="text-569858663" class="widget widget_text">			<div class="textwidget"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- vertical blog -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-9952848327781387"
     data-ad-slot="7274679989"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script></div>
		</aside></div><!-- #content-sidebar -->
<div id="secondary">
		<h2 class="site-description">Tecnologia e informa√ß√£o no lugar certo !</h2>
	
	
		<div id="primary-sidebar" class="primary-sidebar widget-area" role="complementary">
		<aside id="text-569858664" class="widget widget_text"><h1 class="widget-title">Blog Desatualizado</h1>			<div class="textwidget">Depois de muitos anos, est√° na hora de mudar!
Em breve um novo blog, muito melhor e com mais conte√∫do!
Se voc√™ est√° lendo isso, tente acessar <a href="https://rafaelbiriba.com/blog" target="_blank">https://rafaelbiriba.com/blog</a> para ver se o novo blog j√° est√° dispon√≠vel!! :)
Previs√£o de ir online: Agosto/2016</div>
		</aside><aside id="text-347930551" class="widget widget_text"><h1 class="widget-title">Sobre o Autor</h1>			<div class="textwidget"><img alt="" src="https://1.gravatar.com/avatar/908bb0e461d553752af1df7c5849df52?s=80&amp;d=&amp;r=G" class="avatar avatar-42 photo" height="80" width="80">
<div style="text-align: justify;"><strong>Rafael Biriba</strong>: Full Stack Web Developer since 2008 with experience in the development field using technologies like Ruby on Rails, PHP, HTML5, Javascript (Jquery / Backbone.js), Video encoding and delivery (Flash Media Server, Wowza, ffmpeg tools), Database SQL and NoSQL (Mysql, MongoDB, Redis), Virtualization and automation using virtualbox. With knowledge of development techniques and practices such as TDD, Domain Driven Design and Object Oriented Design.</div></div>
		</aside><aside id="github-profile-2" class="widget widget_github-profile"><aside><h1 class="widget-title">Github</h1><div class="github-widget" id="github-profile-2"><header class="github-widget-header"><img class="github-widget-company-logo" title="GitHub" src="https://assets-cdn.github.com/favicon.ico"/><div class="github-widget-header-text"><a class="github-widget-header-link" target="_blank" href="https://github.com/rafaelbiriba" title="View profile">rafaelbiriba (Rafael Biriba)</a></div></header><div class="github-widget-content"><a target="_blank" href="https://github.com/rafaelbiriba" title="View profile"><img class="github-profile-pic" src="https://avatars.githubusercontent.com/u/324743?v=3" style="border-radius: 5px"> <span class="github-names"> <p class="github-name">Rafael Biriba</p> <span class="github-username">rafaelbiriba</span> </span></a><div class="github-block github-vcard-stats"><a class="github-vcard-stat" target='_blank' href="https://github.com/rafaelbiriba/followers"><strong class="github-vcard-stat-count">30</strong><span class="text-muted">Followers</span></a><a class="github-vcard-stat" target='_blank' href="https://github.com/rafaelbiriba/following"><strong class="github-vcard-stat-count">9</strong><span class="text-muted">Following</span></a><div style="clear: both;"></div></div> </div></div></aside></aside><aside id="tag_cloud-2" class="widget widget_tag_cloud"><h1 class="widget-title">Nuvem de Tags</h1><div class="tagcloud"><a href='https://rafaelbiriba.com/tag/904' class='tag-link-127 tag-link-position-1' title='5 t√≥picos' style='font-size: 8pt;'>9.04</a>
<a href='https://rafaelbiriba.com/tag/armazenamento' class='tag-link-76 tag-link-position-2' title='7 t√≥picos' style='font-size: 11.36pt;'>armazenamento</a>
<a href='https://rafaelbiriba.com/tag/atualizando' class='tag-link-132 tag-link-position-3' title='5 t√≥picos' style='font-size: 8pt;'>atualizando</a>
<a href='https://rafaelbiriba.com/tag/atualizar' class='tag-link-130 tag-link-position-4' title='10 t√≥picos' style='font-size: 15.28pt;'>atualizar</a>
<a href='https://rafaelbiriba.com/tag/audio' class='tag-link-22 tag-link-position-5' title='10 t√≥picos' style='font-size: 15.28pt;'>audio</a>
<a href='https://rafaelbiriba.com/tag/blog' class='tag-link-188 tag-link-position-6' title='15 t√≥picos' style='font-size: 19.76pt;'>blog</a>
<a href='https://rafaelbiriba.com/tag/codec' class='tag-link-26 tag-link-position-7' title='12 t√≥picos' style='font-size: 17.24pt;'>codec</a>
<a href='https://rafaelbiriba.com/tag/codigo' class='tag-link-46 tag-link-position-8' title='9 t√≥picos' style='font-size: 14.16pt;'>codigo</a>
<a href='https://rafaelbiriba.com/tag/converter' class='tag-link-23 tag-link-position-9' title='12 t√≥picos' style='font-size: 17.24pt;'>converter</a>
<a href='https://rafaelbiriba.com/tag/decifrar' class='tag-link-79 tag-link-position-10' title='5 t√≥picos' style='font-size: 8pt;'>decifrar</a>
<a href='https://rafaelbiriba.com/tag/desenvolvimento' class='tag-link-487 tag-link-position-11' title='13 t√≥picos' style='font-size: 18.36pt;'>Desenvolvimento</a>
<a href='https://rafaelbiriba.com/tag/disco' class='tag-link-16 tag-link-position-12' title='6 t√≥picos' style='font-size: 9.96pt;'>disco</a>
<a href='https://rafaelbiriba.com/tag/estag' class='tag-link-173 tag-link-position-13' title='9 t√≥picos' style='font-size: 14.16pt;'>estag</a>
<a href='https://rafaelbiriba.com/tag/estagio' class='tag-link-168 tag-link-position-14' title='12 t√≥picos' style='font-size: 17.24pt;'>est√°gio</a>
<a href='https://rafaelbiriba.com/tag/faetec' class='tag-link-192 tag-link-position-15' title='8 t√≥picos' style='font-size: 12.76pt;'>faetec</a>
<a href='https://rafaelbiriba.com/tag/ffmpeg' class='tag-link-484 tag-link-position-16' title='12 t√≥picos' style='font-size: 17.24pt;'>FFmpeg</a>
<a href='https://rafaelbiriba.com/tag/game' class='tag-link-53 tag-link-position-17' title='5 t√≥picos' style='font-size: 8pt;'>game</a>
<a href='https://rafaelbiriba.com/tag/globocom' class='tag-link-171 tag-link-position-18' title='10 t√≥picos' style='font-size: 15.28pt;'>globo.com</a>
<a href='https://rafaelbiriba.com/tag/google' class='tag-link-40 tag-link-position-19' title='7 t√≥picos' style='font-size: 11.36pt;'>google</a>
<a href='https://rafaelbiriba.com/tag/gravar' class='tag-link-24 tag-link-position-20' title='9 t√≥picos' style='font-size: 14.16pt;'>gravar</a>
<a href='https://rafaelbiriba.com/tag/imagem' class='tag-link-29 tag-link-position-21' title='6 t√≥picos' style='font-size: 9.96pt;'>imagem</a>
<a href='https://rafaelbiriba.com/tag/inscricao' class='tag-link-170 tag-link-position-22' title='14 t√≥picos' style='font-size: 19.2pt;'>inscri√ß√£o</a>
<a href='https://rafaelbiriba.com/tag/ist-rio' class='tag-link-191 tag-link-position-23' title='8 t√≥picos' style='font-size: 12.76pt;'>ist-rio</a>
<a href='https://rafaelbiriba.com/tag/leitura' class='tag-link-80 tag-link-position-24' title='7 t√≥picos' style='font-size: 11.36pt;'>leitura</a>
<a href='https://rafaelbiriba.com/tag/medieval' class='tag-link-55 tag-link-position-25' title='5 t√≥picos' style='font-size: 8pt;'>medieval</a>
<a href='https://rafaelbiriba.com/tag/multimedia' class='tag-link-27 tag-link-position-26' title='13 t√≥picos' style='font-size: 18.36pt;'>multimedia</a>
<a href='https://rafaelbiriba.com/tag/online' class='tag-link-51 tag-link-position-27' title='15 t√≥picos' style='font-size: 19.76pt;'>online</a>
<a href='https://rafaelbiriba.com/tag/oportunidade' class='tag-link-169 tag-link-position-28' title='10 t√≥picos' style='font-size: 15.28pt;'>oportunidade</a>
<a href='https://rafaelbiriba.com/tag/player' class='tag-link-34 tag-link-position-29' title='7 t√≥picos' style='font-size: 11.36pt;'>player</a>
<a href='https://rafaelbiriba.com/tag/processo-seletivo' class='tag-link-172 tag-link-position-30' title='14 t√≥picos' style='font-size: 19.2pt;'>processo seletivo</a>
<a href='https://rafaelbiriba.com/tag/ruby' class='tag-link-492 tag-link-position-31' title='10 t√≥picos' style='font-size: 15.28pt;'>Ruby</a>
<a href='https://rafaelbiriba.com/tag/rubygems' class='tag-link-103 tag-link-position-32' title='8 t√≥picos' style='font-size: 12.76pt;'>rubygems</a>
<a href='https://rafaelbiriba.com/tag/rubyonrails' class='tag-link-105 tag-link-position-33' title='5 t√≥picos' style='font-size: 8pt;'>rubyonrails</a>
<a href='https://rafaelbiriba.com/tag/sistema' class='tag-link-133 tag-link-position-34' title='5 t√≥picos' style='font-size: 8pt;'>sistema</a>
<a href='https://rafaelbiriba.com/tag/sistema-operacional' class='tag-link-12 tag-link-position-35' title='5 t√≥picos' style='font-size: 8pt;'>sistema operacional</a>
<a href='https://rafaelbiriba.com/tag/stream' class='tag-link-25 tag-link-position-36' title='8 t√≥picos' style='font-size: 12.76pt;'>stream</a>
<a href='https://rafaelbiriba.com/tag/tecnologia' class='tag-link-490 tag-link-position-37' title='17 t√≥picos' style='font-size: 21.44pt;'>Tecnologia</a>
<a href='https://rafaelbiriba.com/tag/travian' class='tag-link-49 tag-link-position-38' title='6 t√≥picos' style='font-size: 9.96pt;'>travian</a>
<a href='https://rafaelbiriba.com/tag/ubuntu' class='tag-link-11 tag-link-position-39' title='9 t√≥picos' style='font-size: 14.16pt;'>ubuntu</a>
<a href='https://rafaelbiriba.com/tag/versao' class='tag-link-129 tag-link-position-40' title='8 t√≥picos' style='font-size: 12.76pt;'>vers√£o</a>
<a href='https://rafaelbiriba.com/tag/video' class='tag-link-21 tag-link-position-41' title='18 t√≥picos' style='font-size: 22pt;'>video</a>
<a href='https://rafaelbiriba.com/tag/virtual' class='tag-link-17 tag-link-position-42' title='6 t√≥picos' style='font-size: 9.96pt;'>virtual</a>
<a href='https://rafaelbiriba.com/tag/web' class='tag-link-15 tag-link-position-43' title='16 t√≥picos' style='font-size: 20.6pt;'>web</a>
<a href='https://rafaelbiriba.com/tag/web-browser' class='tag-link-56 tag-link-position-44' title='6 t√≥picos' style='font-size: 9.96pt;'>web browser</a>
<a href='https://rafaelbiriba.com/tag/wordpress' class='tag-link-494 tag-link-position-45' title='13 t√≥picos' style='font-size: 18.36pt;'>Wordpress</a></div>
</aside>	</div><!-- #primary-sidebar -->
	</div><!-- #secondary -->

		<div class="cbd"></div>
		<script src="https://rafaelbiriba.com/wp-content/plugins/shutter-reloaded//shutter-reloaded.js?ver=2.5" type="text/javascript"></script>
	<script type="text/javascript">
	var shutterSettings = {"imgDir":"http:\/\/www.rafaelbiriba.com\/wp-content\/plugins\/shutter-reloaded\/\/menu\/","imageCount":true,"FS":false,"textBtns":true,"oneSet":true};
	try{}catch(e){}	</script>
	
		</div><!-- #main -->

		<footer id="colophon" class="site-footer" role="contentinfo">

			
			<div class="site-info">
								<a href="https://br.wordpress.org/">Orgulhosamente mantido com WordPress</a>
			</div><!-- .site-info -->
		</footer><!-- #colophon -->
	</div><!-- #page -->

	
<script type="text/javascript"><!--
wpa2a.targets=[
{title:"Net-SFTP: Calculando o progresso do upload",url:"https://rafaelbiriba.com/2010/11/18/net-sftp-calculando-o-progresso-do-upload.html"},
{title:"Net-sftp: Solu\u00e7\u00e3o para timeout durante o upload",url:"https://rafaelbiriba.com/2010/09/24/problema-no-net-sftp-timeout-para-o-upload.html"}];
wpa2a.html_done=true;if(wpa2a.script_ready&&!wpa2a.done)wpa2a.init();wpa2a.script_load();
//--></script>
<script type='text/javascript'>
/* <![CDATA[ */
var scriptParams = {"google_search_engine_id":"partner-pub-9952848327781387:5952361189"};
/* ]]> */
</script>
<script type='text/javascript' src='https://rafaelbiriba.com/wp-content/plugins/wp-google-search/assets/js/google_cse_v2.js?ver=1'></script>
<script type='text/javascript' src='https://rafaelbiriba.com/wp-content/plugins/contact-form-7/includes/js/jquery.form.min.js?ver=3.51.0-2014.06.20'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var _wpcf7 = {"loaderUrl":"http:\/\/www.rafaelbiriba.com\/wp-content\/plugins\/contact-form-7\/images\/ajax-loader.gif","recaptchaEmpty":"Please verify that you are not a robot.","sending":"Enviando ..."};
/* ]]> */
</script>
<script type='text/javascript' src='https://rafaelbiriba.com/wp-content/plugins/contact-form-7/includes/js/scripts.js?ver=4.4.2'></script>
<script type='text/javascript' src='https://rafaelbiriba.com/wp-content/themes/twentyfourteen/js/functions.js?ver=20150315'></script>
<script type='text/javascript' src='https://rafaelbiriba.com/wp-includes/js/wp-embed.min.js?ver=4.5.3'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"rafaelbiriba"};
/* ]]> */
</script>
<script type='text/javascript' src='https://rafaelbiriba.com/wp-content/plugins/disqus-comment-system/media/js/count.js?ver=4.5.3'></script>
</body>
</html>